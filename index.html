<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Multiplayer Cubes</title>
  <style>
    body { margin:0; overflow:hidden; }
    #colorPicker {
      position: absolute;
      top: 10px; right: 10px;
      z-index: 10;
    }
  </style>
</head>
<body>
  <input type="color" id="colorPicker" value="#888888" />

  <script src="https://unpkg.com/three@0.149.0/build/three.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyC_Op87WdFH-xBlbyBPgH66LilwGZ8Ch5w",
    authDomain: "pasja-data5100s.firebaseapp.com",
    projectId: "pasja-data5100s",
    storageBucket: "pasja-data5100s.firebasestorage.app",
    messagingSenderId: "1042573635103",
    appId: "1:1042573635103:web:9f70d20e5ac49f951b6f2a",
    measurementId: "G-Z2GYGXQTMZ"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  const light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(5, 10, 7);
  scene.add(light);

  const geometry = new THREE.BoxGeometry();
  const material = new THREE.MeshStandardMaterial({ color: 0x888888 });
  const player = new THREE.Mesh(geometry, material);
  scene.add(player);

  const players = {};
  const playerId = Math.random().toString(36).substr(2, 9);

  let radius = 5;
  let theta = 0;
  let phi = Math.PI / 4;
  let isDragging = false;
  let lastX, lastY;

  function updateCamera() {
    const target = player.position;
    camera.position.x = target.x + radius * Math.sin(phi) * Math.cos(theta);
    camera.position.y = target.y + radius * Math.cos(phi);
    camera.position.z = target.z + radius * Math.sin(phi) * Math.sin(theta);
    camera.lookAt(target);
  }
  updateCamera();

  window.addEventListener("mousedown", e => {
    isDragging = true;
    lastX = e.clientX;
    lastY = e.clientY;
  });
  window.addEventListener("mouseup", () => isDragging = false);
  window.addEventListener("mousemove", e => {
    if (!isDragging) return;
    let dx = e.clientX - lastX;
    let dy = e.clientY - lastY;
    theta -= dx * 0.01;
    phi -= dy * 0.01;
    phi = Math.max(0.1, Math.min(Math.PI-0.1, phi));
    updateCamera();
    lastX = e.clientX;
    lastY = e.clientY;
  });
  window.addEventListener("wheel", e => {
    radius += e.deltaY * 0.01;
    radius = Math.max(2, Math.min(20, radius));
    updateCamera();
  });

  const playerRef = db.ref("players/" + playerId);
  playerRef.set({ x:0, y:0, z:0, color:"#888888" });
  playerRef.onDisconnect().remove();

  document.getElementById("colorPicker").addEventListener("input", e => {
    player.material.color.set(e.target.value);
    playerRef.update({ color: e.target.value });
  });

  db.ref("players").on("value", snapshot => {
    const data = snapshot.val() || {};
    for (let id in data) {
      if (id === playerId) continue;
      if (!players[id]) {
        const mesh = new THREE.Mesh(geometry, new THREE.MeshStandardMaterial({ color: data[id].color }));
        scene.add(mesh);
        players[id] = mesh;
      }
      players[id].material.color.set(data[id].color);
      players[id].position.set(data[id].x, data[id].y, data[id].z);
    }
    for (let id in players) {
      if (!data[id]) {
        scene.remove(players[id]);
        delete players[id];
      }
    }
  });

  const keys = {};
  window.addEventListener("keydown", e => keys[e.key] = true);
  window.addEventListener("keyup", e => keys[e.key] = false);

  function animate() {
    requestAnimationFrame(animate);
    let moved = false;
    if (keys["w"]) { player.position.z -= 0.05; moved = true; }
    if (keys["s"]) { player.position.z += 0.05; moved = true; }
    if (keys["a"]) { player.position.x -= 0.05; moved = true; }
    if (keys["d"]) { player.position.x += 0.05; moved = true; }
    if (moved) {
      playerRef.update({ x: player.position.x, y: player.position.y, z: player.position.z });
    }
    updateCamera();
    renderer.render(scene, camera);
  }
  animate();

  window.addEventListener("resize", () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
  </script>
</body>
</html>
